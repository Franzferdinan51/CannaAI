generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Room {
  id        String   @id @default(cuid())
  name      String
  temp      Float?
  humidity  Float?
  co2       Float?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  plants    Plant[]
  sensors   Sensor[]

  @@index([active])
  @@index([name])
}

model Sensor {
  id          String            @id @default(cuid())
  name        String
  type        String
  locationId  String?
  enabled     Boolean           @default(true)
  calibration Json?
  lastValue   Float?
  lastUpdated DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  alerts      Alert[]
  room        Room?             @relation(fields: [locationId], references: [id])
  analytics   SensorAnalytics[]
  readings    SensorReading[]

  @@index([locationId])
  @@index([type])
  @@index([enabled])
  @@index([name])
}

model SensorReading {
  id        String   @id @default(cuid())
  sensorId  String
  value     Float?
  data      Json?
  timestamp DateTime @default(now())
  sensor    Sensor   @relation(fields: [sensorId], references: [id])

  @@index([sensorId, timestamp])
  @@index([sensorId, timestamp, id])
  @@index([timestamp])
}

model Alert {
  id           String   @id @default(cuid())
  sensorId     String?
  type         String
  severity     String
  message      String
  acknowledged Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sensor       Sensor?  @relation(fields: [sensorId], references: [id])

  @@index([sensorId])
  @@index([acknowledged, createdAt])
  @@index([severity, createdAt])
  @@index([type, createdAt])
}

model Notification {
  id                String                 @id @default(cuid())
  type              String
  title             String?
  message           String
  acknowledged      Boolean                @default(false)
  acknowledgedAt    DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  templateId        String?
  metadata          Json?
  template          NotificationTemplate?  @relation(fields: [templateId], references: [id])
  deliveries        NotificationDelivery[]
  webhookDeliveries WebhookDelivery[]

  @@index([acknowledged, createdAt])
  @@index([type, createdAt])
  @@index([templateId])
}

model WebhookSubscription {
  id         String            @id @default(cuid())
  name       String
  url        String
  secret     String?
  events     String
  enabled    Boolean           @default(true)
  retryCount Int               @default(3)
  timeout    Int               @default(5000)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  lastUsed   DateTime?
  isVerified Boolean           @default(false)
  deliveries WebhookDelivery[]

  @@index([enabled])
  @@index([lastUsed])
  @@index([name])
}

model WebhookDelivery {
  id             String              @id @default(cuid())
  webhookId      String
  notificationId String?
  eventType      String
  status         String
  responseCode   Int?
  responseBody   String?
  attempts       Int                 @default(0)
  nextRetryAt    DateTime?
  errorMessage   String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  notification   Notification?       @relation(fields: [notificationId], references: [id])
  webhook        WebhookSubscription @relation(fields: [webhookId], references: [id])

  @@index([status, nextRetryAt])
  @@index([webhookId])
  @@index([eventType, createdAt])
  @@index([notificationId])
}

model NotificationTemplate {
  id            String         @id @default(cuid())
  name          String         @unique
  type          String
  title         String
  message       String
  channels      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  notifications Notification[]
}

model NotificationDelivery {
  id             String       @id @default(cuid())
  notificationId String
  channel        String
  status         String
  provider       String?
  recipient      String?
  messageId      String?
  errorMessage   String?
  attempts       Int          @default(0)
  sentAt         DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  notification   Notification @relation(fields: [notificationId], references: [id])

  @@index([notificationId, channel])
  @@index([status])
}

model NotificationPreference {
  id              String   @id @default(cuid())
  userId          String?
  type            String
  emailEnabled    Boolean  @default(true)
  smsEnabled      Boolean  @default(false)
  pushEnabled     Boolean  @default(true)
  webhookEnabled  Boolean  @default(false)
  discordEnabled  Boolean  @default(false)
  slackEnabled    Boolean  @default(false)
  inAppEnabled    Boolean  @default(true)
  minSeverity     String   @default("info")
  quietHoursStart String?
  quietHoursEnd   String?
  throttleRate    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, type])
}

model AutomationSetting {
  id        Int      @id @default(autoincrement())
  config    Json
  updatedAt DateTime @updatedAt
}

model Strain {
  id                 String   @id @default(cuid())
  name               String
  type               String
  lineage            String?
  description        String?
  isPurpleStrain     Boolean  @default(false)
  optimalConditions  Json?
  commonDeficiencies Json?
  characteristics    Json?
  growingDifficulty  String?
  floweringTime      Int?
  thcLevel           Float?
  cbdLevel           Float?
  effects            Json?
  medicalUses        Json?
  flavors            Json?
  aroma              Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  plants             Plant[]
}

model Plant {
  id                 String                 @id @default(cuid())
  name               String
  strainId           String?
  stage              String?
  health             Json?
  age                Int?
  plantedDate        DateTime?
  locationId         String?
  images             Json?
  notes              String?
  tags               Json?
  metadata           Json?
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  actions            Action[]
  analysisHistory    AnalysisHistory[]
  milestones         AnalysisMilestone[]
  analysisSchedulers AnalysisScheduler[]
  anomalies          AnomalyDetection[]
  automationRules    AutomationRule[]
  room               Room?                  @relation(fields: [locationId], references: [id])
  strain             Strain?                @relation(fields: [strainId], references: [id])
  analyses           PlantAnalysis[]
  healthAnalytics    PlantHealthAnalytics[]
  tasks              Task[]

  @@index([locationId])
  @@index([strainId])
  @@index([isActive])
  @@index([stage])
  @@index([name])
  @@index([createdAt])
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  type        String?
  priority    String?
  status      String    @default("pending")
  notes       String?
  data        Json?
  plantId     String?
  scheduledAt DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  plant       Plant?    @relation(fields: [plantId], references: [id])

  @@index([plantId])
  @@index([status, scheduledAt])
  @@index([status, completedAt])
  @@index([type, status])
  @@index([priority, status])
  @@index([createdAt])
}

model Action {
  id          String   @id @default(cuid())
  plantId     String?
  type        String
  description String
  status      String   @default("pending")
  data        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  plant       Plant?   @relation(fields: [plantId], references: [id])

  @@index([plantId])
  @@index([status, createdAt])
  @@index([type, status])
  @@index([createdAt])
}

model PlantAnalysis {
  id        String   @id @default(cuid())
  plantId   String?
  request   Json?
  result    Json?
  provider  String?
  imageInfo Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  plant     Plant?   @relation(fields: [plantId], references: [id])

  @@index([plantId])
  @@index([provider])
  @@index([createdAt, id])
}

model Metric {
  id        String   @id @default(cuid())
  name      String   @unique
  type      String
  value     Float
  tags      Json?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name, timestamp])
  @@index([timestamp])
  @@index([createdAt])
}

model AnalyticsRecord {
  id           String   @id @default(cuid())
  category     String
  eventType    String
  data         Json
  metadata     Json?
  success      Boolean  @default(true)
  errorMessage String?
  responseTime Float?
  userId       String?
  plantId      String?
  sensorId     String?
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([category, timestamp])
  @@index([eventType, timestamp])
  @@index([timestamp, success])
  @@index([success, timestamp])
  @@index([category, eventType, timestamp])
  @@index([plantId, timestamp])
  @@index([sensorId, timestamp])
  @@index([createdAt])
}

model SensorAnalytics {
  id           String   @id @default(cuid())
  sensorId     String
  reading      Float
  value        Json?
  status       String
  threshold    Float?
  anomalyScore Float?
  temperature  Float?
  humidity     Float?
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())
  sensor       Sensor   @relation(fields: [sensorId], references: [id])

  @@index([sensorId, timestamp])
  @@index([status, timestamp])
  @@index([timestamp])
  @@index([sensorId, status, timestamp])
  @@index([sensorId, createdAt])
}

model PlantHealthAnalytics {
  id              String   @id @default(cuid())
  plantId         String
  analysisId      String?
  healthScore     Float
  healthStatus    String
  issues          Json?
  recommendations Json?
  confidence      Float?
  timestamp       DateTime @default(now())
  createdAt       DateTime @default(now())
  plant           Plant    @relation(fields: [plantId], references: [id])

  @@index([plantId, timestamp])
  @@index([healthStatus, timestamp])
  @@index([timestamp])
  @@index([plantId, healthStatus, timestamp])
  @@index([confidence])
}

model APIPerformanceMetrics {
  id           String   @id @default(cuid())
  endpoint     String
  method       String
  statusCode   Int
  responseTime Float
  success      Boolean
  errorMessage String?
  requestSize  Float?
  responseSize Float?
  userAgent    String?
  ipAddress    String?
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([endpoint, timestamp])
  @@index([statusCode, timestamp])
  @@index([timestamp, success])
  @@index([success, timestamp])
  @@index([method, statusCode])
  @@index([createdAt])
}

model DailyReport {
  id             String   @id @default(cuid())
  date           DateTime @unique
  summary        Json
  metrics        Json
  alertsCount    Int
  actionsCount   Int
  analysisCount  Int
  sensorReadings Int
  generatedAt    DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([date])
}

model AlertThreshold {
  id        String   @id @default(cuid())
  name      String   @unique
  metric    String
  condition String
  value     Float
  severity  String
  enabled   Boolean  @default(true)
  roomId    String?
  sensorId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([metric, enabled])
}

model DataAggregation {
  id        String   @id @default(cuid())
  period    String
  category  String
  metric    String
  value     Float
  count     Int
  min       Float?
  max       Float?
  avg       Float?
  stddev    Float?
  timestamp DateTime
  createdAt DateTime @default(now())

  @@index([period, category, timestamp])
  @@index([timestamp])
}

model AutomationRule {
  id          String    @id @default(cuid())
  name        String
  description String?
  type        String
  enabled     Boolean   @default(true)
  conditions  Json
  actions     Json
  config      Json?
  plantId     String?
  scheduleId  String?
  triggerId   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  trigger     Trigger?  @relation(fields: [triggerId], references: [id])
  schedule    Schedule? @relation(fields: [scheduleId], references: [id])
  plant       Plant?    @relation(fields: [plantId], references: [id])

  @@index([enabled])
  @@index([plantId])
  @@index([type])
  @@index([scheduleId])
}

model Schedule {
  id             String           @id @default(cuid())
  name           String
  description    String?
  cronExpression String
  timezone       String
  type           String
  interval       String?
  enabled        Boolean          @default(true)
  config         Json?
  lastRun        DateTime?
  nextRun        DateTime?
  runCount       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  rules          AutomationRule[]

  @@index([enabled])
  @@index([nextRun])
  @@index([type])
}

model Trigger {
  id            String           @id @default(cuid())
  name          String
  description   String?
  type          String
  conditions    Json
  config        Json?
  enabled       Boolean          @default(true)
  cooldown      Int              @default(3600)
  lastTriggered DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  rules         AutomationRule[]

  @@index([enabled])
  @@index([type])
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String
  enabled     Boolean  @default(true)
  steps       Json
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@index([type])
}

model AnalysisBatch {
  id             String    @id @default(cuid())
  name           String
  description    String?
  type           String
  status         String
  plantIds       String
  totalCount     Int       @default(0)
  completedCount Int       @default(0)
  failedCount    Int       @default(0)
  config         Json?
  results        Json?
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  createdBy      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([type])
}

model AnalysisHistory {
  id           String   @id @default(cuid())
  plantId      String
  analysisType String
  analysisId   String?
  data         Json
  metadata     Json?
  createdAt    DateTime @default(now())
  plant        Plant    @relation(fields: [plantId], references: [id])

  @@index([plantId, createdAt])
  @@index([analysisType, createdAt])
}

model AnomalyDetection {
  id           String    @id @default(cuid())
  plantId      String?
  type         String
  metric       String
  severity     String
  detected     Boolean   @default(true)
  threshold    Float
  currentValue Float
  data         Json?
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())
  plant        Plant?    @relation(fields: [plantId], references: [id])

  @@index([plantId, createdAt])
  @@index([resolved, severity])
  @@index([type, createdAt])
}

model AnalysisScheduler {
  id           String    @id @default(cuid())
  plantId      String?
  analysisType String
  frequency    String
  timeOfDay    String?
  enabled      Boolean   @default(true)
  config       Json?
  lastRun      DateTime?
  nextRun      DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  plant        Plant?    @relation(fields: [plantId], references: [id])

  @@index([enabled])
  @@index([nextRun])
  @@index([plantId])
}

model AnalysisMilestone {
  id             String    @id @default(cuid())
  plantId        String
  type           String
  title          String
  description    String?
  data           Json?
  detectedAt     DateTime  @default(now())
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  plant          Plant     @relation(fields: [plantId], references: [id])

  @@index([plantId, detectedAt])
  @@index([type])
}

model NotificationRule {
  id         String   @id @default(cuid())
  name       String
  type       String
  conditions Json
  channels   String
  template   String?
  enabled    Boolean  @default(true)
  cooldown   Int      @default(3600)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([enabled])
  @@index([type])
}
