# ========================================
# Fluentd Log Configuration
# ========================================

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>

# Parse application logs
<source>
  @type tail
  @id app_logs
  path /var/log/containers/*cannaai-app*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag kubernetes.cannaai-app
  <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

# Parse nginx access logs
<source>
  @type tail
  @id nginx_access_logs
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd-nginx-access.log.pos
  tag nginx.access
  <parse>
    @type regexp
    expression /^(?<remote_addr>[^ ]*) (?<remote_user>[^ ]*) \[(?<time_local>[^\]]*)\] "(?<method>[^ ]*) (?<request>[^ ]*) (?<protocol>[^ ]*)" (?<status>[^ ]*) (?<body_bytes_sent>[^ ]*) "(?<http_referer>[^ ]*)" "(?<http_user_agent>[^ ]*)"/
    time_format %d/%b/%Y:%H:%M:%S %z
  </parse>
</source>

# Parse nginx error logs
<source>
  @type tail
  @id nginx_error_logs
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd-nginx-error.log.pos
  tag nginx.error
  <parse>
    @type regexp
    expression /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>[^\]]*)\] (?<message>.*)/
    time_format %Y/%m/%d %H:%M:%S
  </parse>
</source>

# Filter and add metadata
<filter kubernetes.**>
  @type kubernetes_metadata
</filter>

# Output to stdout (development) or Elasticsearch (production)
<match **>
  @type copy
  <store>
    @type stdout
    output_type json
  </store>
  <store>
    @type file
    path /fluentd/log/cannaai.*.log
    time_slice_format %Y%m%d
    time_slice_wait 10m
    time_format %Y%m%dT%H%M%S%z
    compress gzip
    utc
    format json
  </store>
</match>
